workflows:
  ios_release:
    name: iOS Release (unsigned IPA for Sideloadly)
    max_build_duration: 60
    instance_type: mac_mini_m2
    environment:
      xcode: 16.4
      vars:
        APP_NAME: "ProcureFinder"
        DERIVED_DIR: "build/Derived"
        IPA_DIR: "build/ipa"
    scripts:
      - name: Preflight (Baum & Umgebung)
        script: |
          set -e
          echo "PWD: $(pwd)"
          xcodebuild -version
          echo "Top-Level:"
          ls -la
          echo "Suche project.yml (bis Tiefe 8):"
          find . -maxdepth 8 -name "project.yml" -print || true

      - name: XcodeGen installieren (robust, mit Fallback)
        script: |
          set -euo pipefail
          export PATH="$HOME/.local/bin:$PATH"
          mkdir -p "$HOME/.local/bin"

          if ! command -v xcodegen >/dev/null 2>&1; then
            if command -v brew >/dev/null 2>&1; then
              export HOMEBREW_NO_AUTO_UPDATE=1
              brew list xcodegen >/dev/null 2>&1 || brew install xcodegen || brew reinstall xcodegen || true
            fi
          fi

          if ! command -v xcodegen >/dev/null 2>&1; then
            echo "Fallback: Portable XcodeGen laden…"
            curl -L --fail --retry 5 --retry-delay 2 --retry-connrefused \
              "https://github.com/yonaskolb/XcodeGen/releases/latest/download/xcodegen.zip" \
              -o /tmp/xcodegen.zip
            unzip -o /tmp/xcodegen.zip -d "$HOME/.local/bin"
            chmod +x "$HOME/.local/bin/xcodegen" || true
          fi

          xcodegen --version

      - name: .xcodeproj generieren (aus project.yml, tiefensicher)
        script: |
          set -euo pipefail

          # Alle evtl. alten Projektdateien entfernen
          find . -maxdepth 8 -name "ProcureFinder.xcodeproj" -type d -prune -exec rm -rf {} + || true

          # project.yml-Kandidaten sammeln
          mapfile -t SPEC_CANDIDATES < <(find . -maxdepth 8 -type f -name "project.yml" -print)
          if [ "${#SPEC_CANDIDATES[@]}" -eq 0 ]; then
            echo "FEHLER: Keine project.yml im Repo gefunden."
            exit 1
          fi

          # Besten Kandidaten wählen: bevorzugt Verzeichnis mit ProcureFinder/Sources
          BEST_SPEC=""
          for p in "${SPEC_CANDIDATES[@]}"; do
            d="$(cd "$(dirname "$p")" && pwd)"
            if [ -d "$d/ProcureFinder/Sources" ]; then
              BEST_SPEC="$p"
              break
            fi
          done
          if [ -z "$BEST_SPEC" ]; then
            BEST_SPEC="${SPEC_CANDIDATES[0]}"
          fi

          SPEC_DIR="$(cd "$(dirname "$BEST_SPEC")" && pwd)"
          echo "Gefundene project.yml: $BEST_SPEC"
          echo "Arbeitsordner: $SPEC_DIR"
          cd "$SPEC_DIR"

          # Projekt generieren
          xcodegen generate --spec "$BEST_SPEC"

          # Erzeugte .xcodeproj ermitteln
          PROJECT_PATH="$SPEC_DIR/ProcureFinder.xcodeproj"
          if [ ! -d "$PROJECT_PATH" ]; then
            # Fallback: erste .xcodeproj im Verzeichnis
            PROJECT_PATH="$(find "$SPEC_DIR" -maxdepth 2 -name "*.xcodeproj" -type d | head -n1 || true)"
          fi

          if [ -z "${PROJECT_PATH:-}" ] || [ ! -d "$PROJECT_PATH" ]; then
            echo "FEHLER: Keine .xcodeproj generiert."
            echo "Inhalt von $SPEC_DIR:"
            ls -la "$SPEC_DIR" || true
            echo "Alle .xcodeproj in $SPEC_DIR:"
            find "$SPEC_DIR" -maxdepth 2 -name "*.xcodeproj" -print || true
            exit 1
          fi

          echo "PROJECT_PATH=$PROJECT_PATH"
          # Für Folgeschritte persistieren
          echo "export PROJECT_PATH=\"$PROJECT_PATH\"" >> "$CM_ENV"

          echo "Verfügbare Schemes:"
          xcodebuild -list -project "$PROJECT_PATH" || true

      - name: AppIcon-Contents sicherstellen (Schutz gegen actool)
        script: |
          set -euo pipefail
          ICONCONTENTS="ProcureFinder/Resources/Assets.xcassets/AppIcon.appiconset/Contents.json"
          if [ ! -f "$ICONCONTENTS" ]; then
            echo "AppIcon-Contents fehlt – lege Minimaldatei an."
            mkdir -p "$(dirname "$ICONCONTENTS")"
            printf '%s\n' '{ "images": [], "info": { "version": 1, "author": "xcode" } }' > "$ICONCONTENTS"
          fi

      - name: Build .app (unsigned, für Gerät)
        script: |
          set -euo pipefail
          if [ -z "${PROJECT_PATH:-}" ] || [ ! -d "$PROJECT_PATH" ]; then
            echo "FEHLER: PROJECT_PATH ist nicht gesetzt oder existiert nicht."
            echo "CM_ENV dump:"
            cat "$CM_ENV" || true
            exit 66
          fi

          xcodebuild build \
            -project "$PROJECT_PATH" \
            -scheme "$APP_NAME" \
            -configuration Release \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGNING_IDENTITY= \
            -derivedDataPath "$DERIVED_DIR" \
            | tee build/xcodebuild.log

          APP_OUT="$DERIVED_DIR/Build/Products/Release-iphoneos/${APP_NAME}.app"
          test -d "$APP_OUT" || { echo "FEHLER: .app nicht gefunden unter $APP_OUT"; exit 65; }

      - name: Paketieren als unsigned .ipa (für Sideloadly)
        script: |
          set -euo pipefail
          APP_OUT="$DERIVED_DIR/Build/Products/Release-iphoneos/${APP_NAME}.app"
          mkdir -p "$IPA_DIR/Payload"
          rsync -a "$APP_OUT" "$IPA_DIR/Payload/"
          (cd "$IPA_DIR" && zip -qry "${APP_NAME}-unsigned.ipa" Payload)
          echo "FERTIG: $IPA_DIR/${APP_NAME}-unsigned.ipa"

    artifacts:
      - build/ipa/*.ipa
      - build/Derived/Build/Products/Release-iphoneos/*.app
      - build/xcodebuild.log


